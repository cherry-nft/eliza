# Artcade API Documentation

## Overview

The Artcade API provides a comprehensive set of endpoints for managing game patterns, including pattern generation, storage, retrieval, and evolution. This API is part of the Artcade plugin system located in `packages/plugin-artcade/playground/src/server`.

---

Fixing similar patterns calculation. Error:

[1] [PatternServer] Received similar pattern search request
[1] [PatternServer] Search params: {
[1] patternId: undefined,
[1] type: 'game_mechanic',
[1] threshold: 0.85,
[1] limit: 5
[1] }
[1] Failed to find similar patterns: {
[1] code: 'PGRST202',
[1] details: 'Searched for the function public.match_patterns with parameters match_count, match_threshold, pattern_type, query_embedding or with a single unnamed json/jsonb parameter, but no matches were found in the schema cache.',
[1] hint: 'Perhaps you meant to call the function public.match_patterns(match_count, match_threshold, query_embedding)',
[1] message: 'Could not find the function public.match_patterns(match_count, match_threshold, pattern_type, query_embedding) in the schema cache'
[1] }
[1] [PatternServer] Error finding similar patterns: {
[1] code: 'PGRST202',
[1] details: 'Searched for the function public.match_patterns with parameters match_count, match_threshold, pattern_type, query_embedding or with a single unnamed json/jsonb parameter, but no matches were found in the schema cache.',
[1] hint: 'Perhaps you meant to call the function public.match_patterns(match_count, match_threshold, query_embedding)',
[1] message: 'Could not find the function public.match_patterns(match_count, match_threshold, pattern_type, query_embedding) in the schema cache'
[1] }

---

<!-- 12-18-2024 -->

_1. Initial Prompt Submission:_

Handling prompt submit: make me an NBA style shot clock that's counting down from 2025
App.tsx:115 Generating pattern from prompt

This shows the user's prompt being received and the generation process starting.

_2. Client Pattern Service:_

ClientPatternService.ts:53 [ClientPatternService] Generating pattern with prompt: make me an NBA style shot clock that's counting down from 2025
ClientPatternService.ts:53 [ClientPatternService] Fetching /generate Object

The ClientPatternService begins processing the prompt and makes a request to the /generate endpoint.

_3. App Rendering:_

App.tsx:58 App component rendering
hook.js:377 App component rendering

The React app updates its UI state to reflect that generation is in progress.

_4. Pattern Generation Success:_

ClientPatternService.ts:53 [ClientPatternService] Successful response from /generate: Object

The server successfully generated the HTML pattern.

_5. Pattern Creation:_

App.tsx:144 Creating game pattern from Claude output
App.tsx:163 Created game pattern: Object

The generated HTML is converted into a game pattern object.

_6. Similar Patterns Search:_

App.tsx:165 Searching for similar patterns
ClientPatternService.ts:53 [ClientPatternService] Fetching /search/similar Object

The app tries to find similar patterns in the database.

Initial Prompt Submission:

Basically, when the pattern is generated by Claude (successful response from /generate), it creates an HTML pattern

The app then tries to convert this into a game pattern and search for similar patterns using:

```typescript
async searchSimilarPatterns(pattern: GamePattern): Promise<GamePattern[]> {
    return this.fetchWithLogging<GamePattern[]>("/search/similar", {
        method: "POST",
        body: JSON.stringify({
            html: pattern.content.html,
            type: pattern.type,
        }),
    });
}
```

## Current State

Server Output (pnpm run dev:server):
✅ Server is running and processing requests
✅ Vector embeddings are being generated successfully
✅ Memory management is working (storing/retrieving patterns)
✅ Pattern tracking is functioning (usage counts, audit logs)
✅ Database operations are being logged properly

Test Output (pnpm test:endpoints):
✅ Health check passed
✅ Pattern generation working (with correct HTML output)
✅ Pattern storage successful (with proper ID generation)
✅ Pattern retrieval working
✅ Similar pattern search working (both by ID and HTML)
✅ Usage tracking functioning

The most important thing to note is that we're seeing full end-to-end functionality:

- The server can generate embeddings
- The VectorDB is storing and retrieving patterns
- The similarity search is working
- The audit logging system is capturing operations

## Base URL

```
http://localhost:3001/api/patterns
```

## Types

All type definitions can be found in `packages/plugin-artcade/playground/src/shared/types/pattern.types.ts`

### Core Types

```typescript
interface GeneratedPattern {
    title: string;
    description: string;
    html: string;
    css?: string[];
    javascript?: string[];
    plan?: string;
}

interface PatternStorageRequest {
    type: string;
    pattern_name: string;
    content: {
        html: string;
        css?: string[];
        javascript?: string[];
    };
}

interface PatternUsageContext {
    prompt?: string;
    generated_html?: string;
    quality_scores?: {
        visual: number;
        interactive: number;
        functional: number;
        performance: number;
    };
}
```

## Endpoints

### Health Check

```http
GET /health
```

Checks the health status of the API server.

**Response**

```json
{
    "status": "healthy",
    "timestamp": "2024-01-20T12:00:00.000Z"
}
```

### Generate Pattern

```http
POST /generate
```

Generates a new pattern based on the provided prompt using Claude AI.

**Request Body**

```json
{
    "prompt": "Create a simple button that pulses with a subtle glow effect when hovered"
}
```

**Response**

```typescript
interface PatternGenerationResponse {
    success: true;
    data: GeneratedPattern;
}
```

**Example Response**

```json
{
    "success": true,
    "data": {
        "title": "Pulsing Glow Button with Hover Effect",
        "description": "A modern button with a subtle pulsing glow effect on hover",
        "html": "<button class='glow-button'>Click Me</button>",
        "css": [".glow-button { ... }", ".glow-button:hover { ... }"]
    }
}
```

**Error Response**

```json
{
    "success": false,
    "error": {
        "message": "Error message",
        "details": {} // Optional validation or generation errors
    }
}
```

### Store Pattern

```http
POST /store
```

Stores a pattern in the vector database with embedding generation.

**Request Body**

```typescript
PatternStorageRequest;
```

**Response**

```typescript
interface PatternStorageResponse {
    success: true;
    data: {
        id: string;
        type: string;
        pattern_name: string;
        content: {
            html: string;
            css?: string[];
            javascript?: string[];
        };
        embedding: number[];
        effectiveness_score: number;
        usage_count: number;
    };
}
```

### Retrieve Pattern

```http
GET /:id
```

Retrieves a specific pattern by ID.

**Response**

```typescript
interface PatternRetrievalResponse {
    success: true;
    data: {
        id: string;
        type: string;
        pattern_name: string;
        content: {
            html: string;
            css?: string[];
            javascript?: string[];
        };
        embedding: number[];
        effectiveness_score: number;
        usage_count: number;
    };
}
```

### Search Similar Patterns

```http
POST /search/similar
```

Finds patterns similar to either a provided pattern ID or HTML content.

**Request Body**

```typescript
interface SimilarPatternsRequest {
    patternId?: string;
    html?: string;
    type?: string;
    threshold?: number;
    limit?: number;
}
```

**Response**

```typescript
interface SimilarPatternsResponse {
    success: true;
    data: Array<{
        id: string;
        type: string;
        pattern_name: string;
        content: {
            html: string;
            css?: string[];
            javascript?: string[];
        };
        embedding: number[];
        effectiveness_score: number;
        usage_count: number;
        similarity_score: number;
    }>;
}
```

### Track Pattern Usage

```http
POST /:id/track-usage
```

Tracks pattern usage and updates effectiveness scores.

**Request Body**

```typescript
PatternUsageContext;
```

**Response**

```typescript
interface PatternUsageResponse {
    success: true;
    data: {
        pattern_id: string;
        new_score: number;
        usage_count: number;
    };
}
```

## Error Handling

All endpoints follow a consistent error response format:

```typescript
interface ErrorResponse {
    success: false;
    error: {
        message: string;
        details?: unknown;
    };
}
```

Common HTTP status codes:

- 400: Bad Request (invalid input)
- 404: Not Found (pattern not found)
- 500: Internal Server Error

## Implementation Details

### Server Setup

- Main server file: `packages/plugin-artcade/playground/src/server/index.ts`
- Router implementation: `packages/plugin-artcade/playground/src/server/patternServer.ts`
- Configuration: `packages/plugin-artcade/playground/src/server/config/serverConfig.ts`

### Services

- Claude AI Service: `packages/plugin-artcade/playground/src/server/services/ClaudeService.ts`
- Vector Database: `packages/plugin-artcade/src/services/VectorDatabase.ts`
- Pattern Evolution: `packages/plugin-artcade/src/services/PatternEvolution.ts`

### Testing

Test files are available for all major components:

- Endpoint Tests: `packages/plugin-artcade/playground/src/server/test-endpoints.ts`
- Generation Tests: `packages/plugin-artcade/playground/src/server/test-generations.ts`
- Integration Tests: `packages/plugin-artcade/playground/src/server/test-server-integration.ts`

Run tests using:

```bash
pnpm test:endpoints    # Test all API endpoints
pnpm test:generations # Test pattern generation
pnpm test:integration # Test service integration
```

## Special Notes

1. **Embeddings**: Pattern storage automatically generates embeddings for similarity search using the HTML content.

2. **Effectiveness Scoring**: The effectiveness score is calculated as an average of visual, interactive, functional, and performance scores when provided in usage tracking.

3. **Pattern Evolution**: The system supports pattern evolution through the similarity search feature, allowing for iterative improvements based on successful patterns.

4. **Rate Limiting**: Currently in development. Plan to add rate limiting middleware for production use.

5. **Environment Variables**: Required environment variables:
    ```
    VITE_OPENROUTER_API_KEY=your_api_key
    ```

## Client Integration

A client service is available at `packages/plugin-artcade/playground/src/services/ClientPatternService.ts` for easy integration with the frontend. This service handles all API communication and provides typed responses.

Example client usage:

```typescript
import { ClientPatternService } from "../services/ClientPatternService";

const client = new ClientPatternService();

// Generate a pattern
const pattern = await client.generatePattern(
    "Create a button with a rainbow gradient",
);

// Store the pattern
const stored = await client.storePattern({
    type: "ui",
    pattern_name: pattern.title,
    content: {
        html: pattern.html,
        css: pattern.css,
    },
});
```
