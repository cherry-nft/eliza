<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="Interactive Music Visualizer" />
        <meta name="theme-color" content="#111111" />
        <title>LET'S PARTY !!!</title>
        <!-- External Libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
            rel="stylesheet"
        />

        <style>
            body {
                background: #111;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                margin: 0;
                overflow: hidden;
                font-family: Arial, sans-serif;
                perspective: 1000px;
                position: relative;
            }

            .scanline-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.4) 0px,
                    rgba(0, 0, 0, 0.4) 2px,
                    transparent 2px,
                    transparent 4px
                );
                pointer-events: none;
                z-index: 9999;
                animation: scanlineMove 8s linear infinite;
            }
            @keyframes scanlineMove {
                0% {
                    background-position: 0 0;
                }
                100% {
                    background-position: 0 200px;
                }
            }

            .tube-container {
                display: flex;
                gap: 8px;
                transform: perspective(1000px) rotateX(60deg);
                margin-top: 100px;
                animation: containerFloat 8s infinite ease-in-out;
                transition: transform 0.3s ease;
            }
            .tube-container:hover {
                transform: perspective(1000px) rotateX(55deg) translateY(-20px);
            }
            @keyframes containerFloat {
                0%,
                100% {
                    transform: perspective(1000px) rotateX(60deg)
                        translateY(0px);
                }
                50% {
                    transform: perspective(1000px) rotateX(60deg)
                        translateY(-40px);
                }
            }

            .tube {
                width: 20px;
                height: 300px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 10px;
                position: relative;
                overflow: hidden;
                transform-origin: bottom;
                transition: all 0.3s ease;
                box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.2);
            }

            .glow {
                position: absolute;
                top: 0;
                width: 100%;
                height: 0%;
                background: transparent;
                opacity: 1;
                transition:
                    height 0.1s ease-out,
                    filter 0.2s ease,
                    box-shadow 0.2s ease;
                filter: blur(12px);
                box-shadow: 0 0 60px rgba(255, 255, 255, 0.95);
                mix-blend-mode: screen;
            }

            .start-button {
                position: relative;
                padding: 25px 50px;
                font-size: 20px;
                font-weight: bold;
                color: #fff;
                background: linear-gradient(45deg, #ff0080, #7000ff);
                border: none;
                border-radius: 20px;
                cursor: pointer;
                transform-style: preserve-3d;
                transform: translateZ(0);
                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                box-shadow:
                    0 15px 35px rgba(255, 0, 128, 0.5),
                    0 0 0 5px rgba(255, 0, 128, 0.1),
                    0 10px 20px rgba(0, 0, 0, 0.3);
                margin-bottom: 60px;
                text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
                letter-spacing: 2px;
                white-space: nowrap;
                line-height: 1.2;
                animation: buttonFloat 3s infinite ease-in-out;
                overflow: hidden;
            }
            .start-button::before {
                content: "";
                position: absolute;
                inset: -10px;
                background: linear-gradient(
                    45deg,
                    #ff0080,
                    #7000ff,
                    #00ffea,
                    #ff0080
                );
                background-size: 400% 400%;
                filter: blur(20px);
                z-index: -1;
                opacity: 0;
                transition: opacity 0.4s;
                animation: gradientMove 3s ease infinite;
            }
            .start-button::after {
                content: "";
                position: absolute;
                inset: 0;
                background: radial-gradient(
                    circle at var(--x, 50%) var(--y, 50%),
                    rgba(255, 255, 255, 0.2) 0%,
                    transparent 60%
                );
                opacity: 0;
                transition: opacity 0.3s;
            }
            @keyframes gradientMove {
                0% {
                    background-position: 0% 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
                100% {
                    background-position: 0% 50%;
                }
            }
            .start-button:hover {
                transform: translateY(-8px) translateZ(30px) rotateX(15deg);
                box-shadow:
                    0 25px 45px rgba(255, 0, 128, 0.8),
                    0 0 0 8px rgba(255, 0, 128, 0.2),
                    0 15px 25px rgba(0, 0, 0, 0.4);
                background: linear-gradient(45deg, #ff0080, #9500ff);
            }
            .start-button:hover::before {
                opacity: 1;
            }
            .start-button:hover::after {
                opacity: 1;
            }
            @keyframes buttonFloat {
                0%,
                100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-5px);
                }
            }
            .start-button:active {
                transform: translateY(2px) translateZ(10px);
                box-shadow:
                    0 8px 25px rgba(255, 0, 128, 0.6),
                    0 0 0 3px rgba(255, 0, 128, 0.15),
                    0 5px 10px rgba(0, 0, 0, 0.2);
            }
            .start-button::before {
                content: "";
                position: absolute;
                inset: -8px;
                background: linear-gradient(45deg, #ff0080, #7000ff, #00ffea);
                filter: blur(20px);
                z-index: -1;
                opacity: 0;
                transition: opacity 0.4s;
            }
            .start-button:hover::before {
                opacity: 1;
            }

            @media (max-width: 1200px) {
                .tube-container {
                    transform: perspective(1000px) rotateX(60deg) scale(0.8);
                    margin-top: 50px;
                }
                .disco-ball {
                    transform: scale(0.8);
                }
            }
            @media (max-width: 768px) {
                .tube-container {
                    transform: perspective(1000px) rotateX(60deg) scale(0.6);
                    margin-top: 30px;
                }
                .disco-ball {
                    transform: scale(0.6);
                }
                .start-button {
                    padding: 20px 40px;
                    font-size: 18px;
                }
            }
            @media (max-width: 480px) {
                .tube-container {
                    transform: perspective(1000px) rotateX(60deg) scale(0.4);
                    margin-top: 20px;
                }
                .disco-ball {
                    transform: scale(0.4);
                }
                .start-button {
                    padding: 15px 30px;
                    font-size: 16px;
                }
            }

            .collection-button {
                position: fixed;
                bottom: 20px;
                left: 20px;
                padding: 15px 30px;
                font-size: 18px;
                font-weight: bold;
                color: #fff;
                background: linear-gradient(45deg, #00ff88, #00a8ff);
                border: none;
                border-radius: 15px;
                cursor: pointer;
                text-decoration: none;
                transform-style: preserve-3d;
                transition: all 0.3s ease;
                box-shadow:
                    0 10px 25px rgba(0, 255, 136, 0.5),
                    0 0 0 4px rgba(0, 255, 136, 0.1),
                    0 8px 15px rgba(0, 0, 0, 0.3);
            }
            .collection-button:hover {
                transform: translateY(-5px) scale(1.05);
                box-shadow:
                    0 15px 30px rgba(0, 255, 136, 0.7),
                    0 0 0 6px rgba(0, 255, 136, 0.2),
                    0 12px 20px rgba(0, 0, 0, 0.4);
            }

            .credits {
                position: fixed;
                bottom: 20px;
                right: 20px;
                color: #fff;
                font-family: "Press Start 2P", cursive;
                font-size: 14px;
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            }

            @keyframes discoBallRotateLeft {
                0% {
                    transform: translateY(-150px) rotateY(0deg) rotateX(20deg);
                }
                100% {
                    transform: translateY(-150px) rotateY(360deg) rotateX(20deg);
                }
            }
            @keyframes discoBallRotateRight {
                0% {
                    transform: translateY(-150px) rotateY(360deg) rotateX(20deg);
                }
                100% {
                    transform: translateY(-150px) rotateY(0deg) rotateX(20deg);
                }
            }
            .disco-ball {
                width: 100px;
                height: 100px;
                position: absolute;
                top: 50%;
                transform-style: preserve-3d;
                z-index: 999;
            }
            .disco-ball-left {
                left: calc(50% - 300px);
                animation: discoBallRotateLeft 8s linear infinite;
                transform: translateY(-150px);
                z-index: 999;
            }
            .disco-ball-right {
                right: calc(50% - 300px);
                animation: discoBallRotateRight 8s linear infinite;
                transform: translateY(-150px);
                z-index: 999;
            }
            .disco-ball-inner {
                width: 100%;
                height: 100%;
                position: relative;
                transform-style: preserve-3d;
                animation: discoBallSparkle 2s linear infinite;
            }
            .disco-facet {
                position: absolute;
                width: 10px;
                height: 10px;
                background: rgba(255, 255, 255, 0.8);
                border-radius: 50%;
                transform-style: preserve-3d;
                backface-visibility: hidden;
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            }
            @keyframes discoBallSparkle {
                0%,
                100% {
                    opacity: 0.8;
                }
                50% {
                    opacity: 1;
                }
            }

            .confetti {
                position: absolute;
                font-family: monospace;
                pointer-events: none;
                z-index: 900;
                transform-origin: center;
                user-select: none;
                opacity: 0;
                animation:
                    confettiFall var(--fall-duration, 8s) ease-out forwards,
                    confettiFadeIn 0.5s ease-out forwards;
                text-shadow:
                    0 0 10px currentColor,
                    0 0 20px currentColor,
                    0 0 30px currentColor;
                font-size: 24px;
            }
            @keyframes confettiFall {
                0% {
                    transform: translateY(0) translateX(0) rotate(0deg);
                    opacity: 1;
                }
                25% {
                    transform: translateY(-600px) translateX(var(--x-spread))
                        rotate(180deg);
                    opacity: 1;
                }
                50% {
                    transform: translateY(-500px)
                        translateX(calc(var(--x-spread) * 2)) rotate(360deg);
                    opacity: 0.8;
                }
                100% {
                    transform: translateY(100vh)
                        translateX(calc(var(--x-spread) * 3)) rotate(720deg);
                    opacity: 0;
                }
            }
            @keyframes confettiFadeIn {
                0% {
                    opacity: 0;
                }
                100% {
                    opacity: 1;
                }
            }

            .firework {
                position: absolute;
                pointer-events: none;
                z-index: 999;
            }
            .particle {
                position: absolute;
                width: 4px;
                height: 4px;
                border-radius: 50%;
                pointer-events: none;
            }
            @keyframes fireworkFade {
                0% {
                    opacity: 1;
                }
                100% {
                    opacity: 0;
                }
            }
        </style>
    </head>

    <body>
        <div class="scanline-overlay"></div>
        <button class="start-button">LET'S PARTY<br />START MUSIC</button>
        <div class="tube-container"></div>
        <a
            href="https://codepen.io/collection/xebYxo"
            class="collection-button"
            target="_blank"
            >MY COLLECTION</a
        >
        <div class="credits">CODE by HL</div>

        <script>
            const AudioContext =
                window.AudioContext || window.webkitAudioContext;
            const requestAnimFrame =
                window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame;

            if (!AudioContext) {
                alert(
                    "Web Audio API is not supported in your browser. Please use a modern browser."
                );
            }

            let audioCtx = null;
            let analyser = null;
            let audioElement = null;
            let animationFrame = null;
            let isPlaying = false;
            let isProcessing = false;

            const sound = new Howl({
                src: [
                    "https://www.amigaremix.com/listen/2526/neriakx_-_enigma_gun_extended_mix_-_amigaremix_02526.mp3",
                ],
                format: ["mp3"],
                html5: true,
                preload: true,
                onend: stopMusic,
                onloaderror: (id, error) =>
                    console.error("Loading error:", error),
                onplayerror: (id, error) =>
                    console.error("Playback error:", error),
            });

            const container = document.querySelector(".tube-container");
            const startButton = document.querySelector(".start-button");

            let discoBallLeft, discoBallRight;

            function initDiscoBalls() {
                discoBallLeft = createDiscoBall("left");
                discoBallRight = createDiscoBall("right");
            }

            function createConfetti(x, y, intensity) {
                const characters = [
                    "♠",
                    "♣",
                    "♥",
                    "♦",
                    "☺",
                    "☻",
                    "♪",
                    "♫",
                    "○",
                    "◎",
                    "●",
                    "◐",
                    "◑",
                    "░",
                    "▒",
                    "▓",
                    "█",
                    "←",
                    "↑",
                    "→",
                    "↓",
                    "┌",
                    "┐",
                    "└",
                    "┘",
                    "@",
                    "#",
                    "$",
                    "%",
                    "&",
                    "∞",
                    "☮",
                    "☯",
                ];

                const colors = [
                    "#ff0080",
                    "#00ff00",
                    "#0000ff",
                    "#ffff00",
                    "#ff00ff",
                    "#00ffff",
                ];
                const count = Math.floor(intensity * 3);

                for (let i = 0; i < count; i++) {
                    const confetti = document.createElement("div");
                    confetti.className = "confetti";
                    confetti.style.background = "none";
                    confetti.style.color =
                        colors[Math.floor(Math.random() * colors.length)];
                    confetti.textContent =
                        characters[
                            Math.floor(Math.random() * characters.length)
                        ];

                    const isLeftBall = x < window.innerWidth / 2;
                    const xSpread =
                        (Math.random() * 600 + 300) *
                        (isLeftBall
                            ? -Math.cos((35 * Math.PI) / 180)
                            : Math.cos((35 * Math.PI) / 180));

                    confetti.style.setProperty("--x-spread", `${xSpread}px`);
                    confetti.style.fontSize = "24px";
                    confetti.style.fontFamily = "monospace";
                    confetti.style.setProperty(
                        "--fall-duration",
                        `${8 + Math.random() * 4}s`
                    );

                    confetti.style.left = `${x}px`;
                    confetti.style.top = `${y}px`;

                    confetti.style.textShadow = `0 0 ${intensity * 5}px currentColor,
                              0 0 ${intensity * 10}px currentColor,
                              0 0 ${intensity * 15}px currentColor`;

                    document.body.appendChild(confetti);

                    setTimeout(() => {
                        if (confetti && confetti.parentNode) {
                            confetti.style.opacity = "0";
                            confetti.style.transition = "opacity 0.5s ease-out";
                            setTimeout(() => confetti.remove(), 500);
                        }
                    }, 7500);
                }
            }

            function createFirework(x, y, intensity) {
                const colors = [
                    "#ff0080",
                    "#00ff00",
                    "#0000ff",
                    "#ffff00",
                    "#ff00ff",
                    "#00ffff",
                ];
                const particles = 12 + Math.floor(intensity * 8);

                const firework = document.createElement("div");
                firework.className = "firework";
                firework.style.left = `${x}px`;
                firework.style.top = `${y}px`;

                for (let i = 0; i < particles; i++) {
                    const particle = document.createElement("div");
                    particle.className = "particle";

                    const angle = (i / particles) * Math.PI * 2;
                    const velocity = 2 + Math.random() * 2;
                    const spread = 100 + intensity * 100;

                    const color =
                        colors[Math.floor(Math.random() * colors.length)];
                    particle.style.background = color;
                    particle.style.boxShadow = `0 0 ${4 + intensity * 4}px ${color}`;

                    const animation = particle.animate(
                        [
                            {
                                transform: "translate(0, 0) scale(1)",
                                opacity: 1,
                            },
                            {
                                transform: `translate(${Math.cos(angle) * spread}px, ${
                                    Math.sin(angle) * spread
                                }px) scale(0.1)`,
                                opacity: 0,
                            },
                        ],
                        {
                            duration: 1000 + Math.random() * 500,
                            easing: "cubic-bezier(0,0,0.2,1)",
                            fill: "forwards",
                        }
                    );

                    firework.appendChild(particle);

                    animation.onfinish = () => {
                        particle.remove();
                        if (firework.children.length === 0) {
                            firework.remove();
                        }
                    };
                }

                document.body.appendChild(firework);

                setTimeout(() => {
                    if (firework && firework.parentNode) {
                        firework.remove();
                    }
                }, 2000);
            }

            async function cleanup() {
                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                    animationFrame = null;
                }

                if (audioElement) {
                    audioElement.pause();
                    audioElement.src = "";
                    audioElement.removeAttribute("src");
                    audioElement.load();
                    audioElement = null;
                }

                if (sound) {
                    sound.unload();
                }

                if (audioCtx && audioCtx.state !== "closed") {
                    audioCtx.close().catch(console.error);
                    audioCtx = null;
                }

                if (analyser) {
                    analyser.disconnect();
                    analyser = null;
                }
            }

            async function createAudioContext() {
                try {
                    return new (window.AudioContext ||
                        window.webkitAudioContext)();
                } catch (e) {
                    console.error("Failed to create AudioContext:", e);
                    alert(
                        "Your browser does not support Web Audio API. Please use a modern browser."
                    );
                    throw e;
                }
            }

            async function setupAudioAnalysis() {
                try {
                    if (!audioCtx) {
                        audioCtx = await createAudioContext();
                        analyser = audioCtx.createAnalyser();
                        analyser.fftSize = 64;
                        analyser.smoothingTimeConstant = 0.8;

                        if (!audioElement) {
                            audioElement = new Audio();
                            audioElement.crossOrigin = "anonymous";
                            audioElement.src = sound._src;

                            const loadPromise = new Promise(
                                (resolve, reject) => {
                                    audioElement.addEventListener(
                                        "loadeddata",
                                        resolve,
                                        { once: true }
                                    );
                                    audioElement.addEventListener(
                                        "error",
                                        reject,
                                        { once: true }
                                    );
                                }
                            );

                            await loadPromise;

                            const source =
                                audioCtx.createMediaElementSource(audioElement);
                            source.connect(analyser);
                            analyser.connect(audioCtx.destination);
                        }
                    }

                    if (audioCtx.state === "suspended") {
                        await audioCtx.resume();
                    }

                    return audioCtx;
                } catch (error) {
                    console.error("Audio setup error:", error);
                    cleanup();
                    throw error;
                }
            }

            async function stopMusic() {
                if (isProcessing) return;
                isProcessing = true;

                try {
                    if (animationFrame) {
                        cancelAnimationFrame(animationFrame);
                        animationFrame = null;
                    }

                    if (audioElement) {
                        audioElement.pause();
                        audioElement.currentTime = 0;
                    }

                    sound.stop();
                    isPlaying = false;
                    startButton.innerHTML = "LET'S PARTY<br>START MUSIC";

                    document.querySelectorAll(".glow").forEach((tube) => {
                        tube.style.height = "0%";
                        tube.style.filter = "blur(3px)";
                        tube.style.boxShadow = "none";
                    });

                    document.querySelectorAll(".tube").forEach((tube) => {
                        tube.style.height = "300px";
                        tube.style.transform = "none";
                    });
                } catch (error) {
                    console.error("Error stopping music:", error);
                } finally {
                    setTimeout(() => {
                        isProcessing = false;
                    }, 300);
                }
            }

            async function startMusic() {
                if (isProcessing || isPlaying) return;
                isProcessing = true;

                try {
                    await setupAudioAnalysis();

                    const playPromise = Promise.all([
                        new Promise((resolve) => {
                            sound.once("play", resolve);
                            sound.play();
                        }),
                        audioElement.play(),
                    ]);

                    await playPromise;

                    isPlaying = true;
                    startButton.textContent = "STOP MUSIC";

                    updateVUMeter();

                    startButton.style.transform = "scale(1.1)";
                    createFirework(
                        startButton.offsetLeft + startButton.offsetWidth / 2,
                        startButton.offsetTop + startButton.offsetHeight / 2,
                        1
                    );
                } catch (error) {
                    console.error("Error starting music:", error);
                    await stopMusic();
                } finally {
                    setTimeout(() => {
                        isProcessing = false;
                    }, 300);
                }
            }

            window.addEventListener("unload", cleanup);
            window.addEventListener("beforeunload", cleanup);
            window.addEventListener("visibilitychange", () => {
                if (document.hidden && isPlaying) {
                    stopMusic();
                }
            });

            document.addEventListener(
                "touchstart",
                function (e) {
                    if (e.target.classList.contains("start-button")) {
                        e.preventDefault();
                        e.target.click();
                    }
                },
                { passive: false }
            );

            startButton.addEventListener("click", async () => {
                if (isProcessing) return;
                try {
                    if (isPlaying) {
                        await stopMusic();
                    } else {
                        await startMusic();
                    }
                } catch (error) {
                    console.error("Button click error:", error);
                    isProcessing = false;
                }
            });

            createTubes();
            initDiscoBalls();

            function createTubes() {
                container.innerHTML = "";
                for (let i = 0; i < 30; i++) {
                    const tube = document.createElement("div");
                    tube.className = "tube";
                    tube.style.height = "300px";

                    const glow = document.createElement("div");
                    glow.className = "glow";
                    glow.style.height = "0%";

                    tube.appendChild(glow);
                    container.appendChild(tube);
                }
            }

            function createDiscoBall(side) {
                const ball = document.createElement("div");
                ball.className = `disco-ball disco-ball-${side}`;

                const inner = document.createElement("div");
                inner.className = "disco-ball-inner";

                for (let i = 0; i < 8; i++) {
                    for (let j = 0; j < 8; j++) {
                        const facet = document.createElement("div");
                        facet.className = "disco-facet";

                        const phi = (i / 8) * Math.PI * 2;
                        const theta = (j / 8) * Math.PI;
                        const radius = 50;

                        const x = radius * Math.sin(theta) * Math.cos(phi);
                        const y = radius * Math.sin(theta) * Math.sin(phi);
                        const z = radius * Math.cos(theta);

                        facet.style.transform = `translate3d(${x + 45}px, ${y + 45}px, ${z}px)`;
                        inner.appendChild(facet);
                    }
                }

                ball.appendChild(inner);
                document.body.appendChild(ball);
                return ball;
            }

            function updateVUMeter() {
                if (!isPlaying || !analyser) return;

                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);

                const tubes = document.querySelectorAll(".glow");
                const tubeElements = document.querySelectorAll(".tube");
                const time = Date.now() / 1000;

                const c64Colors = [
                    "#FF1E1E",
                    "#00FFFF",
                    "#FF00FF",
                    "#40FF40",
                    "#4040FF",
                    "#FFB000",
                    "#FFA000",
                    "#FF8000",
                    "#FF4040",
                    "#80FF80",
                    "#8040FF",
                    "#FFFF40",
                ];

                tubes.forEach((tube, index) => {
                    const center = tubes.length / 2;
                    const distanceFromCenter = Math.abs(index - center);
                    const amplificationFactor = Math.max(
                        0,
                        1 - distanceFromCenter / center
                    );

                    const value = dataArray[index % dataArray.length];
                    const amplifiedValue =
                        value * (1 + amplificationFactor * 2.5);
                    const baseHeight = (amplifiedValue / 255) * 100;

                    const waveOffset =
                        Math.sin(time * 3.5 + index * 0.4) *
                        (amplifiedValue / 7);
                    const finalHeight = Math.max(
                        0,
                        Math.min(100, baseHeight + waveOffset)
                    );

                    tube.style.height = `${finalHeight}%`;

                    const tubeHeight = 200 + amplifiedValue * 0.6;
                    tubeElements[index].style.height = `${tubeHeight}px`;

                    const colorIndex1 = Math.floor(
                        (time * 2 + index) % c64Colors.length
                    );
                    const colorIndex2 = (colorIndex1 + 4) % c64Colors.length;
                    const colorIndex3 = (colorIndex1 + 8) % c64Colors.length;

                    const color1 = c64Colors[colorIndex1];
                    const color2 = c64Colors[colorIndex2];
                    const color3 = c64Colors[colorIndex3];

                    const pulseScale = 1 + (amplifiedValue / 255) * 1.5;
                    const basePulse =
                        Math.sin(time * 4 + index * 0.2) * 0.3 + 0.7;
                    const combinedPulse = pulseScale * basePulse;

                    const glowIntensity = Math.min(
                        800,
                        amplifiedValue * 4 * combinedPulse
                    );

                    tube.style.filter = `
          blur(${12 + (amplifiedValue / 255) * 30 * combinedPulse}px)
          saturate(600%)
          brightness(${2.0 + (amplifiedValue / 255) * 1.2 * combinedPulse})
        `;

                    tube.style.boxShadow = `
          0 0 ${glowIntensity * 2.0 * combinedPulse}px ${color1},
          0 0 ${glowIntensity * 6 * combinedPulse}px ${color2},
          0 0 ${glowIntensity * 8 * combinedPulse}px ${color3},
          0 0 ${glowIntensity * 10 * combinedPulse}px rgba(${color1}aa, 0.9),
          0 0 ${glowIntensity * 14 * combinedPulse}px rgba(${color2}aa, 0.7)
        `;

                    tube.style.background = `linear-gradient(180deg,
            ${color1} ${combinedPulse * 15}%,
            ${color2} 50%,
            ${color3} ${85 + combinedPulse * 15}%),
            linear-gradient(90deg,
            rgba(255,255,255,${0.5 * combinedPulse}) 0%,
            rgba(255,255,255,${0.6 * combinedPulse}) 50%,
            rgba(255,255,255,${0.5 * combinedPulse}) 100%)
        `;

                    const xOffset =
                        Math.sin(time * 4.5 + index * 0.5) *
                        (amplifiedValue / 10);
                    const yOffset =
                        Math.cos(time * 3.5 + index * 0.4) *
                        (amplifiedValue / 12);
                    tubeElements[index].style.transform =
                        `translate(${xOffset}px, ${yOffset}px)`;
                });

                const averageIntensity =
                    dataArray.reduce((a, b) => a + b, 0) / dataArray.length;

                const discoBalls = document.querySelectorAll(".disco-ball");
                discoBalls.forEach((ball) => {
                    const inner = ball.querySelector(".disco-ball-inner");
                    const facets = ball.querySelectorAll(".disco-facet");

                    const rotationSpeed = 8 - (averageIntensity / 255) * 4;
                    ball.style.animationDuration = `${rotationSpeed}s`;

                    facets.forEach((facet, idx) => {
                        const dataIndex = idx % dataArray.length;
                        const intensity = dataArray[dataIndex] / 255;

                        const colorIndex =
                            Math.floor(time * 2 + idx) % c64Colors.length;
                        const color = c64Colors[colorIndex];

                        facet.style.backgroundColor = color;
                        facet.style.boxShadow = `0 0 ${10 + intensity * 20}px ${color}`;
                        facet.style.opacity = 0.5 + intensity * 0.5;
                    });
                });

                if (isPlaying) {
                    const intensity = Math.min(1, averageIntensity / 200);
                    const pulseScale = 1 + intensity * 0.2;
                    const hueRotate = (time * 50) % 360;

                    startButton.style.transform = `scale(${pulseScale})`;
                    startButton.style.boxShadow = `
          0 ${15 + intensity * 20}px ${35 + intensity * 30}px rgba(255, 0, 128, ${0.5 + intensity * 0.5}),
          0 0 0 ${5 + intensity * 3}px rgba(255, 0, 128, ${0.1 + intensity * 0.2}),
          0 \${10 + intensity * 15}px \${20 + intensity * 25}px rgba(0,0,0,\${0.3 + intensity * 0.3}),
          inset 0 0 ${50 * intensity}px rgba(255,255,255,${0.5 * intensity})
        `;

                    startButton.style.background = `
          linear-gradient(${time * 30}deg,
              hsl(${hueRotate}, 100%, 50%),
              hsl(${(hueRotate + 60) % 360}, 100%, 50%),
              hsl(${(hueRotate + 180) % 360}, 100%, 50%)
          )
        `;

                    startButton.style.setProperty(
                        "--x",
                        `${50 + Math.sin(time * 2) * 50}%`
                    );
                    startButton.style.setProperty(
                        "--y",
                        `${50 + Math.cos(time * 2) * 50}%`
                    );

                    startButton.style.textShadow = `
          0 0 ${5 + intensity * 10}px rgba(255, 255, 255, ${0.5 + intensity * 0.5}),
          0 0 ${10 + intensity * 20}px rgba(255, 0, 128, ${0.3 + intensity * 0.4}),
          0 0 ${15 + intensity * 30}px rgba(112, 0, 255, ${0.2 + intensity * 0.3})
        `;
                }

                if (isPlaying) {
                    const buttonGlow = Math.min(1, averageIntensity / 200);
                    startButton.style.boxShadow = `
          0 15px 35px rgba(255, 0, 128, ${0.5 + buttonGlow}),
          0 0 0 5px rgba(255, 0, 128, ${0.1 + buttonGlow * 0.2}),
          0 10px 20px rgba(0, 0, 0, ${0.3 + buttonGlow * 0.3})
        `;

                    if (averageIntensity > 120) {
                        const leftRect = discoBallLeft.getBoundingClientRect();
                        const rightRect =
                            discoBallRight.getBoundingClientRect();

                        createConfetti(
                            leftRect.left + leftRect.width / 2,
                            leftRect.top + leftRect.height / 2,
                            averageIntensity / 255
                        );
                        createConfetti(
                            rightRect.left + rightRect.width / 2,
                            rightRect.top + rightRect.height / 2,
                            averageIntensity / 255
                        );
                    }

                    if (averageIntensity > 120) {
                        const buttonRect = startButton.getBoundingClientRect();
                        const x =
                            buttonRect.left + Math.random() * buttonRect.width;
                        const y =
                            buttonRect.top + Math.random() * buttonRect.height;

                        createFirework(x, y, (averageIntensity / 255) * 0.5);
                    }
                }

                const containerWave =
                    Math.sin(time * 2.5) * (averageIntensity / 18);
                container.style.transform = `perspective(1000px) rotateX(${60 + containerWave}deg) rotateY(${containerWave / 1.8}deg)`;

                animationFrame = requestAnimationFrame(updateVUMeter);
            }
        </script>
    </body>
</html>
